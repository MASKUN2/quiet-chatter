<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quiet Chatter</title>
    <link href="/images/quiet-chatter-icon.png" rel="icon" type="image/png">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .search-container {
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-top: 1rem;
        }

        .book-card {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="search-container">
        <div class="text-center">
            <img alt="Quiet Chatter Icon" src="/images/quiet-chatter-icon2.png"
                 style="width: 200px; height: 200px; margin-bottom: 1rem;">
        </div>
        <form id="searchForm">
            <div class="input-group mb-3">
                <input class="form-control" id="keyword" name="keyword" placeholder="검색어를 입력하세요" required type="text">
                <button class="btn btn-primary" type="submit">검색</button>
            </div>
        </form>
    </div>

    <div class="mt-4" id="results"></div>
    <nav class="mt-4" id="pagination"></nav>
</div>

<script>
    const searchForm = document.getElementById('searchForm');
    const keywordInput = document.getElementById('keyword');
    const resultsContainer = document.getElementById('results');
    const paginationContainer = document.getElementById('pagination');

    let currentPage = 0;

    searchForm.addEventListener('submit', function (e) {
        e.preventDefault();
        currentPage = 0;
        searchBooks();
    });

    function searchBooks() {
        const keyword = keywordInput.value;
        if (!keyword) {
            return;
        }

        fetch(`/api/books?keyword=${keyword}&page=${currentPage}&sort=title,asc`)
            .then(response => response.json())
            .then(data => {
                if (data.page) { // Check if the new structure is present
                    renderResults(data.content);
                    const pageData = {
                        ...data.page,
                        first: data.page.number === 0,
                        last: data.page.number === data.page.totalPages - 1
                    };
                    renderPagination(pageData);
                } else { // Fallback to the original Spring Page structure
                    renderResults(data.content);
                    renderPagination(data);
                }
            })
            .catch(error => {
                console.error('Error fetching search results:', error);
                resultsContainer.innerHTML = '<div class="alert alert-danger">검색 중 오류가 발생했습니다.</div>';
            });
    }

    function renderResults(books) {
        if (books.length === 0) {
            resultsContainer.innerHTML = '<div class="alert alert-info">검색 결과가 없습니다.</div>';
            return;
        }

        resultsContainer.innerHTML = books.map(book => `
            <div class="card book-card">
                <div class="card-body d-flex align-items-center">
                    ${book.thumbnailImageUrl ? `<a href="${book.externalLinkUrl}" target="_blank"><img src="${book.thumbnailImageUrl}" alt="${book.title}" style="width: 60px; height: 90px; margin-right: 15px; object-fit: contain;"></a>` : ''}
                    <div>
                        <h5 class="card-title">${book.title}</h5>
                        <p class="card-text text-muted">저자: ${book.author}</p>
                        <p class="card-text text-muted">ISBN: ${book.isbn}</p>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderPagination(page) {
        paginationContainer.innerHTML = '';
        if (page.totalPages <= 1) {
            return;
        }

        const ul = document.createElement('ul');
        ul.className = 'pagination justify-content-center';

        // Previous button
        if (!page.first) {
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item';
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${page.number - 1}">이전</a>`;
            ul.appendChild(prevLi);
        }

        // Page numbers
        const maxPagesToShow = 10;
        let startPage = Math.max(0, page.number - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(page.totalPages - 1, startPage + maxPagesToShow - 1);

        // Adjust startPage if endPage is at the limit but we have fewer than maxPagesToShow before startPage
        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(0, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === page.number ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i + 1}</a>`;
            ul.appendChild(li);
        }

        // Next button
        if (!page.last) {
            const nextLi = document.createElement('li');
            nextLi.className = 'page-item';
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${page.number + 1}">다음</a>`;
            ul.appendChild(nextLi);
        }

        paginationContainer.appendChild(ul);
    }

    paginationContainer.addEventListener('click', function (e) {
        if (e.target.tagName === 'A' && e.target.dataset.page) {
            e.preventDefault();
            currentPage = parseInt(e.target.dataset.page, 10);
            searchBooks();
        }
    });
</script>

</body>
</html>
