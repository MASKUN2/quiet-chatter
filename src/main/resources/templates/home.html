<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quiet Chatter</title>
    <link href="/images/quiet-chatter-icon.png" rel="icon" type="image/png">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .recent-talks-section {
            background-color: #ffffff; /* White background */
            padding: 1.5rem; /* Add some padding */
            border-radius: 0.5rem; /* Rounded corners */
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* Subtle shadow */
            min-height: 250px; /* Add min-height to prevent layout jump */
        }

        .recent-talks-section .list-group-item {
            max-width: 90%; /* Make items narrower than the container */
            margin-left: auto; /* Center the items */
            margin-right: auto;
            margin-bottom: 0.5rem; /* Add some space between items */
        }

        /* Remove bottom margin for the last item */
        .recent-talks-section .list-group-item:last-child {
            margin-bottom: 0;
        }

        /* Media query for mobile responsiveness */
        @media (max-width: 576px) {
            .container { /* Target the main container */
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            .recent-talks-section {
                padding-left: 0;
                padding-right: 0;
            }

            .recent-talks-section .list-group-item {
                max-width: 100%; /* Full width on small screens */
                margin-left: 0;
                margin-right: 0;
            }
        }

        /* Skeleton UI Styles */
        .skeleton {
            animation: skeleton-loading 1s linear infinite alternate;
        }

        @keyframes skeleton-loading {
            0% {
                background-color: hsl(200, 20%, 80%);
            }
            100% {
                background-color: hsl(200, 20%, 95%);
            }
        }

        .skeleton-avatar {
            width: 50px;
            height: 75px; /* Approximate book cover aspect ratio */
            border-radius: 0.25rem;
        }

        .skeleton-text {
            height: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>

<div class="container">
    <div th:replace="~{fragments/search :: book-search}"></div>

    <!-- Recent BookTalks Section -->
    <div class="recent-talks-section mt-5">
        <h2 class="text-center">ìƒˆë¡œ ì˜¬ë¼ì˜¨ ë¶í†¡</h2>
        <div class="list-group" id="recent-talks-container">
            <!-- Recent talks will be dynamically inserted here -->
        </div>
    </div>

    <!-- GIF Display Section -->
    <div class="recent-talks-section mt-5 text-center"> <!-- text-center ì¶”ê°€ -->
        <h3 class="text-center">ì´ë ‡ê²Œ ì‚¬ìš©í•´ë³´ì„¸ìš” :)</h3>
        <img alt="ì‚¬ìš© ì‹œì—° GIF" class="img-fluid" src="/images/ì‚¬ìš©ì‹œì—°.gif"
             style="max-width: 70%; height: auto; border-radius: 0.5rem; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); display: block; margin: 0 auto;">
        <!-- max-width 70% ë° ì¤‘ì•™ ì •ë ¬ ì¶”ê°€ -->
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetchRecentTalksAndBooks();
    });

    function renderRecentTalksSkeleton(count = 4) {
        const container = document.getElementById('recent-talks-container');
        const skeletonHTML = Array(count).fill(0).map(() => `
            <a class="list-group-item list-group-item-action text-decoration-none text-dark">
                <div class="d-flex w-100 align-items-center">
                    <!-- Skeleton Book Info -->
                    <div class="skeleton skeleton-avatar me-3"></div>

                    <!-- Skeleton Talk Content -->
                    <div class="flex-grow-1" style="min-width: 0;">
                        <div class="skeleton skeleton-text" style="width: 60%;"></div>
                        <div class="skeleton skeleton-text" style="width: 40%;"></div>
                        <div class="skeleton skeleton-text" style="width: 80%;"></div>
                    </div>

                    <!-- Skeleton Reactions -->
                    <div class="d-flex align-items-center gap-2 px-2">
                         <div class="skeleton skeleton-text" style="width: 25px;"></div>
                         <div class="skeleton skeleton-text" style="width: 25px;"></div>
                    </div>
                </div>
            </a>
        `).join('');
        container.innerHTML = skeletonHTML;
    }

    async function fetchRecentTalksAndBooks() {
        const container = document.getElementById('recent-talks-container');
        renderRecentTalksSkeleton(); // Show skeleton UI first

        try {
            // 1. Fetch recent talks
            const talksResponse = await fetch('/api/talks?recent-limit=4');
            if (!talksResponse.ok) throw new Error('ìµœê·¼ ë¶í†¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            const talks = await talksResponse.json();

            if (talks.length === 0) {
                container.innerHTML = '<p class="text-muted">ìµœê·¼ ë“±ë¡ëœ ë¶í†¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // 2. Extract unique book IDs
            const bookIds = [...new Set(talks.map(talk => talk.bookId))];

            // 3. Fetch corresponding book info
            const booksResponse = await fetch(`/api/books?id=${bookIds.join(',')}`);
            if (!booksResponse.ok) throw new Error('ì±… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            const books = await booksResponse.json();

            // Create a map for easy lookup
            const booksMap = new Map(books.map(book => [book.id, book]));

            // 4. Render the combined data
            renderRecentTalks(talks, booksMap);

        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }

    function renderRecentTalks(talks, booksMap) {
        const container = document.getElementById('recent-talks-container');
        container.innerHTML = talks.map(talk => {
            const book = booksMap.get(talk.bookId);
            if (!book) return ''; // Skip if book info is not found for some reason

            const truncatedContent = talk.content.length > 100 ? talk.content.substring(0, 100) + '...' : talk.content;

            return `
                <a href="/books/${book.id}" class="list-group-item list-group-item-action text-decoration-none text-dark">
                    <div class="d-flex w-100 align-items-center">
                        <!-- Book Info -->
                        <img src="${book.thumbnailImageUrl || '/images/quiet-chatter-icon.png'}" alt="${book.title}" class="me-3" style="width: 50px; height: auto; border-radius: 0.25rem; object-fit: cover;">

                        <!-- Talk Content -->
                        <div class="flex-grow-1" style="min-width: 0;"> <!-- min-width: 0 to help with truncation -->
                            <h6 class="mb-1 text-truncate">${book.title}</h6>
                            <small class="text-muted d-block mb-1 text-truncate">${book.author}</small>
                            <p class="mb-1 text-muted text-truncate"><em>"${truncatedContent}"</em></p>
                        </div>

                        <!-- Reactions -->
                        <div class="d-flex align-items-center gap-2 px-2">
                            <span class="text-nowrap">ğŸ‘ ${talk.like_count}</span>
                            <span class="text-nowrap">â¤ï¸ ${talk.support_count}</span>
                        </div>
                    </div>
                </a>
            `;
        }).join('');
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
