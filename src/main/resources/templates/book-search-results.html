<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Search Results - Quiet Chatter</title>
    <th:block th:replace="~{fragments/common-assets :: css}"></th:block>
    <style>
        h5.card-title a {
            color: inherit;
            text-decoration: none;
        }

        h5.card-title a:hover {
            text-decoration: underline;
        }

        .results-container {
            min-height: 500px; /* 레이아웃 깨짐 방지 */
        }

        .skeleton-avatar {
            width: 60px;
            height: 90px;
            margin-right: 15px;
            border-radius: 0.25rem;
        }

        /* 모바일 반응형 미디어 쿼리 */
        @media (max-width: 576px) {
            .card.book-card {
                border-radius: 0;
                border-left: 0;
                border-right: 0;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- 검색 양식 컴포넌트 -->
    <div th:replace="~{fragments/search :: book-search}"></div>

    <!-- 결과 및 페이지네이션 플레이스홀더 -->
    <div class="mt-4 results-container" id="results"></div>
    <nav class="mt-4" id="pagination"></nav>
</div>

<!-- 결과 가져오기 및 렌더링을 위한 스크립트 -->
<script type="module">
    import * as api from '/js/api.js';

    // --- 상수 ---
    const keywordInput = document.getElementById('keyword');
    const resultsContainer = document.getElementById('results');
    const paginationContainer = document.getElementById('pagination');

    // --- 초기화 ---
    document.addEventListener('DOMContentLoaded', () => {
        const params = getUrlParams();
        if (params.keyword) {
            keywordInput.value = params.keyword;
            searchBooks(params.keyword, params.page);
        }
    });

    // --- 데이터 가져오기 ---
    async function searchBooks(keyword, page) {
        if (!keyword) return;
        renderResultsSkeleton();
        const apiPage = Math.max(0, page - 1);
        try {
            const pageData = await api.searchBooks(keyword, apiPage);
            renderPage(pageData);
        } catch (error) {
            console.error('Error fetching search results:', error);
            resultsContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }

    // --- UI 렌더링 ---
    function renderPage(pageData) {
        if (pageData && pageData.content && pageData.content.length > 0) {
            renderResults(pageData.content);
            renderPagination(pageData.pageInfo);
        } else {
            renderNoResults();
        }
    }

    function renderResults(books) {
        resultsContainer.innerHTML = books.map(book => `
            <div class="card book-card">
                <div class="card-body d-flex align-items-center" style="min-height: 122px;">
                    ${book.thumbnailImageUrl ? `<a href="/books/${book.id}"><img src="${book.thumbnailImageUrl}" alt="${book.title}" style="width: 60px; height: 90px; margin-right: 15px; object-fit: contain;"></a>` : '<div style="width: 60px; height: 90px; margin-right: 15px;"></div>'}
                    <div style="max-height: 90px; overflow: hidden;">
                        <h5 class="card-title text-truncate"><a href="/books/${book.id}">${book.title}</a></h5>
                        <p class="card-text text-muted text-truncate">저자: ${book.author}</p>
                        <p class="card-text text-muted text-truncate">ISBN: ${book.isbn}</p>
                    </div>
                </div>
            </div>`).join('');
    }

    function renderPagination(pageInfo) {
        paginationContainer.innerHTML = '';
        if (pageInfo.totalPages <= 1) return;

        const ul = document.createElement('ul');
        ul.className = 'pagination justify-content-center';
        const keyword = keywordInput.value;

        // 이전 버튼
        ul.appendChild(createPaginationLink('이전', keyword, pageInfo.number, pageInfo.first));

        // 페이지 번호
        const maxPagesToShow = 6;
        let startPage = Math.max(0, pageInfo.number - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(pageInfo.totalPages - 1, startPage + maxPagesToShow - 1);
        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(0, endPage - maxPagesToShow + 1);
        }
        for (let i = startPage; i <= endPage; i++) {
            ul.appendChild(createPaginationLink(i + 1, keyword, i + 1, false, i === pageInfo.number));
        }

        // 다음 버튼
        ul.appendChild(createPaginationLink('다음', keyword, pageInfo.number + 2, pageInfo.last));

        paginationContainer.appendChild(ul);
    }

    function renderNoResults() {
        resultsContainer.innerHTML = '<div class="alert alert-info">검색 결과가 없습니다.</div>';
        paginationContainer.innerHTML = '';
    }

    function renderResultsSkeleton(count = 10) {
        resultsContainer.innerHTML = Array(count).fill(0).map(() => `
            <div class="card book-card">
                <div class="card-body d-flex align-items-center" style="min-height: 122px;">
                    <div class="skeleton skeleton-avatar"></div>
                    <div style="max-height: 90px; overflow: hidden;">
                        <div class="skeleton skeleton-text" style="width: 300px;"></div>
                        <div class="skeleton skeleton-text" style="width: 150px;"></div>
                        <div class="skeleton skeleton-text" style="width: 200px;"></div>
                    </div>
                </div>
            </div>`).join('');
    }

    // --- UI 헬퍼 ---
    function createPaginationLink(text, keyword, pageNum, isDisabled = false, isActive = false) {
        const li = document.createElement('li');
        li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = `/books/search?keyword=${keyword}&page=${pageNum}`;
        a.textContent = text;
        li.appendChild(a);
        return li;
    }

    // --- 유틸리티 ---
    function getUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
            keyword: urlParams.get('keyword'),
            page: parseInt(urlParams.get('page'), 10) || 1
        };
    }
</script>
<th:block th:replace="~{fragments/common-assets :: js}"></th:block>
</body>
</html>
