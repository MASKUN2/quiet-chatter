<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Search Results - Quiet Chatter</title>
    <link href="/images/quiet-chatter-icon.png" rel="icon" type="image/png">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        h5.card-title a {
            color: inherit;
            text-decoration: none;
        }

        h5.card-title a:hover {
            text-decoration: underline;
        }

        .results-container {
            min-height: 500px; /* Prevent layout jump */
        }

        /* Skeleton UI Styles */
        .skeleton {
            animation: skeleton-loading 1s linear infinite alternate;
        }

        @keyframes skeleton-loading {
            0% {
                background-color: hsl(200, 20%, 80%);
            }
            100% {
                background-color: hsl(200, 20%, 95%);
            }
        }

        .skeleton-avatar {
            width: 60px;
            height: 90px;
            margin-right: 15px;
            border-radius: 0.25rem;
        }

        .skeleton-text {
            height: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- The search form component -->
    <div th:replace="~{fragments/search :: book-search}"></div>

    <!-- Results and pagination placeholders -->
    <div class="mt-4 results-container" id="results"></div>
    <nav class="mt-4" id="pagination"></nav>
</div>

<!-- Script for fetching and rendering results -->
<script>
    const keywordInput = document.getElementById('keyword');
    const resultsContainer = document.getElementById('results');
    const paginationContainer = document.getElementById('pagination');

    function renderResultsSkeleton(count = 10) {
        const skeletonHTML = Array(count).fill(0).map(() => `
            <div class="card book-card">
                <div class="card-body d-flex align-items-center" style="min-height: 122px;">
                    <div class="skeleton skeleton-avatar"></div>
                    <div style="max-height: 90px; overflow: hidden;">
                        <div class="skeleton skeleton-text" style="width: 300px;"></div>
                        <div class="skeleton skeleton-text" style="width: 150px;"></div>
                        <div class="skeleton skeleton-text" style="width: 200px;"></div>
                    </div>
                </div>
            </div>
        `).join('');
        resultsContainer.innerHTML = skeletonHTML;
    }

    function searchBooks(keyword, page) {
        if (!keyword) {
            return;
        }

        renderResultsSkeleton(); // Show skeleton UI first

        // Convert 1-based page from URL to 0-based for API
        let apiPage = page - 1;
        if (apiPage < 0) apiPage = 0; // Ensure page doesn't go below 0

        fetch(`/api/books?keyword=${keyword}&page=${apiPage}&sort=title,asc`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // The API response has a 'content' array and a 'page' object.
                if (data && data.content) {
                    renderResults(data.content);
                    if (data.page) {
                        renderPagination(data.page);
                    }
                } else {
                    resultsContainer.innerHTML = '<div class="alert alert-info">검색 결과가 없습니다.</div>';
                    paginationContainer.innerHTML = '';
                }
            }).catch(error => {
            console.error('Error fetching search results:', error);
            resultsContainer.innerHTML = '<div class="alert alert-danger">검색 중 오류가 발생했습니다.</div>';
        });
    }

    function renderResults(books) {
        if (books.length === 0) {
            resultsContainer.innerHTML = '<div class="alert alert-info">검색 결과가 없습니다.</div>';
            return;
        }

        resultsContainer.innerHTML = books.map(book => `
            <div class="card book-card">
                <div class="card-body d-flex align-items-center" style="min-height: 122px;">
                    ${book.thumbnailImageUrl ? `<a href="/books/${book.id}"><img src="${book.thumbnailImageUrl}" alt="${book.title}" style="width: 60px; height: 90px; margin-right: 15px; object-fit: contain;"></a>` : '<div style="width: 60px; height: 90px; margin-right: 15px;"></div>'}
                    <div style="max-height: 90px; overflow: hidden;">
                        <h5 class="card-title text-truncate"><a href="/books/${book.id}">${book.title}</a></h5>
                        <p class="card-text text-muted text-truncate">저자: ${book.author}</p>
                        <p class="card-text text-muted text-truncate">ISBN: ${book.isbn}</p>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderPagination(page) { // 'page' here is the 0-based Spring Page object
        paginationContainer.innerHTML = '';
        if (page.totalPages <= 1) {
            return;
        }

        const ul = document.createElement('ul');
        ul.className = 'pagination justify-content-center';
        const keyword = keywordInput.value;

        // Previous button
        if (!page.first) {
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item';
            // URL page parameter is 1-based (current 0-based page number)
            prevLi.innerHTML = `<a class="page-link" href="/books/search?keyword=${keyword}&page=${page.number}">이전</a>`;
            ul.appendChild(prevLi);
        }

        // Page numbers
        const maxPagesToShow = 6;
        let startPage = Math.max(0, page.number - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(page.totalPages - 1, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(0, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === page.number ? 'active' : ''}`;
            // URL page parameter is 1-based (i + 1)
            li.innerHTML = `<a class="page-link" href="/books/search?keyword=${keyword}&page=${i + 1}">${i + 1}</a>`;
            ul.appendChild(li);
        }

        // Next button
        if (!page.last) {
            const nextLi = document.createElement('li');
            nextLi.className = 'page-item';
            // URL page parameter is 1-based (current 0-based page number + 2)
            nextLi.innerHTML = `<a class="page-link" href="/books/search?keyword=${keyword}&page=${page.number + 2}">다음</a>`;
            ul.appendChild(nextLi);
        }

        paginationContainer.appendChild(ul);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // This script now lives in and acts upon the search results page.
        const urlParams = new URLSearchParams(window.location.search);
        const keyword = urlParams.get('keyword');
        // Default to 1 for the first page if 'page' parameter is missing or invalid
        const page = parseInt(urlParams.get('page'), 10) || 1;

        if (keyword) {
            keywordInput.value = keyword;
            searchBooks(keyword, page);
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
