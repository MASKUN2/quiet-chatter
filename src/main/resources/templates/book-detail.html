<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Book Detail - Quiet Chatter</title>
    <link href="/images/quiet-chatter-icon.png" rel="icon" type="image/png">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .book-detail-container {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-top: 2rem;
            min-height: 300px; /* Add min-height */
        }

        .book-image {
            max-width: 100%;
            height: 350px; /* Fixed height to match skeleton */
            object-fit: contain; /* Scale image correctly within fixed height */
            border-radius: 0.5rem;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
        }

        .book-info h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .book-info p {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .book-info .description {
            margin-top: 1.5rem;
            line-height: 1.6;
        }

        .booktalk-section {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            min-height: 400px; /* Add min-height */
        }

        .reacted {
            font-weight: bold;
            color: #007bff;
        }

        .reaction-btn {
            cursor: pointer;
            user-select: none;
            border: 1px solid #ced4da;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        @media (max-width: 767.98px) {
            .book-info h1 {
                font-size: 1.75rem;
            }

            .book-detail-container {
                margin-top: 1rem;
            }
        }

        /* Skeleton UI Styles */
        .skeleton {
            animation: skeleton-loading 1s linear infinite alternate;
        }

        @keyframes skeleton-loading {
            0% {
                background-color: hsl(200, 20%, 80%);
            }
            100% {
                background-color: hsl(200, 20%, 95%);
            }
        }

        .skeleton-image {
            width: 100%;
            height: 350px;
            border-radius: 0.5rem;
        }

        .skeleton-text {
            height: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0.25rem;
            background-color: #e0e0e0;
        }

        .talk-content-text {
            white-space: pre-wrap;
            word-break: break-word;
        }

        @media (max-width: 380px) {
            .reaction-buttons-container {
                display: flex;
                flex-direction: column;
                align-items: flex-end; /* Right-align the buttons */
            }

            .reaction-buttons-container .reaction-btn {
                margin-right: 0 !important; /* Remove right margin */
                margin-bottom: 0.5rem; /* Add some space between stacked buttons */
            }

            .reaction-buttons-container .reaction-btn:last-child {
                margin-bottom: 0; /* No margin for the last button */
            }
        }

        /* Media query for mobile responsiveness */
        @media (max-width: 576px) {
            .container { /* Target the main container */
                padding-left: 0 !important;
                padding-right: 0 !important;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Add the common search component -->
    <div th:replace="~{fragments/search :: book-search}"></div>

    <div class="book-detail-container">
        <h2 class="mb-3">ë„ì„œ ìƒì„¸ì •ë³´</h2>
        <div class="row">
            <div class="col-12 col-md-4 text-center">
                <!-- Skeleton for image, replaced by JS -->
                <div id="book-image-container">
                    <div class="skeleton skeleton-image"></div>
                </div>
                <img alt="Book cover" class="book-image d-none" id="book-image" src="">
            </div>
            <div class="col-12 col-md-8 book-info mt-3 mt-md-0">
                <!-- Skeletons for text, replaced by JS -->
                <h1 id="book-title">
                    <div class="skeleton skeleton-text" style="width: 80%;"></div>
                </h1>
                <p><strong>ì €ì:</strong> <span id="book-author"><span class="skeleton skeleton-text d-inline-block"
                                                                     style="width: 40%;"></span></span></p>
                <p><strong>ISBN:</strong> <span id="book-isbn"><span class="skeleton skeleton-text d-inline-block"
                                                                     style="width: 50%;"></span></span></p>
                <div class="description" id="book-description">
                    <div class="skeleton skeleton-text" style="width: 100%;"></div>
                    <div class="skeleton skeleton-text" style="width: 100%;"></div>
                    <div class="skeleton skeleton-text" style="width: 70%;"></div>
                </div>
            </div>
        </div>
    </div>


    <!-- BookTalk Section -->
    <div class="booktalk-section mt-5">
        <h2>ë¶í†¡ <small class="text-muted">BookTalk</small></h2>

        <!-- Talk Post Form -->
        <form class="mt-4 mb-4" id="talk-form">
            <div class="mb-3">
                <textarea class="form-control" id="talk-content" maxlength="250" placeholder="ë¶í†¡ì„ ë‚¨ê²¨ì£¼ì„¸ìš”... (ìµœëŒ€ 250ì)"
                          required rows="3"></textarea>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted" data-bs-placement="top" data-bs-toggle="tooltip"
                      title="ì´ ê¸€ì€ 12ê°œì›” í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€ë©ë‹ˆë‹¤.">
                    ğŸ•—
                </span>
                <button class="btn btn-primary" type="submit">ë“±ë¡</button>
            </div>
        </form>
        <hr/>

        <div class="mt-3" id="talks-container"></div>
        <nav class="mt-3" id="talks-pagination"></nav>
    </div>
</div>

<script>
    const bookId = window.location.pathname.split('/').pop();
    const talksContainer = document.getElementById('talks-container');
    const talksPaginationContainer = document.getElementById('talks-pagination');
    const talkForm = document.getElementById('talk-form');
    const talkContentInput = document.getElementById('talk-content');
    let currentPage = 0;

    document.addEventListener('DOMContentLoaded', function () {
        if (bookId) {
            fetchBookDetails(bookId);
            fetchTalks(bookId, 0); // Fetch first page of items
        }
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });

    talkForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const content = talkContentInput.value;
        if (content) {
            const now = new Date();
            now.setUTCMonth(now.getUTCMonth() + 12);
            const hiddenTimestamp = now.toISOString();
            postTalk(bookId, content, hiddenTimestamp);
        }
    });

    function postTalk(bookId, content, hiddenTimestamp) {
        fetch('/api/talks', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({bookId: bookId, content: content, hidden: hiddenTimestamp})
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || 'ë¶í†¡ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.')
                    });
                }
                return response.json();
            })
            .then(data => {
                talkContentInput.value = '';
                fetchTalks(bookId, 0);
            })
            .catch(error => {
                console.error('Error posting talk:', error);
                alert(error.message);
            });
    }

    function fetchBookDetails(bookId) {
        fetch(`/api/books/${bookId}`)
            .then(response => {
                if (!response.ok) throw new Error('Book not found');
                return response.json();
            })
            .then(book => {
                renderBookDetail(book);
            })
            .catch(error => {
                console.error('Error fetching book details:', error);
                document.querySelector('.book-detail-container').innerHTML = '<div class="alert alert-danger">ì±… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            });
    }

    function renderBookDetail(book) {
        document.title = book.title + ' - Quiet Chatter';

        // --- Image Handling ---
        const bookImage = document.getElementById('book-image');
        const bookImageContainer = document.getElementById('book-image-container');

        if (book.thumbnailImageUrl) {
            bookImage.src = book.thumbnailImageUrl;
            bookImage.alt = book.title;
            bookImage.classList.remove('d-none'); // Show actual image
            bookImageContainer.classList.add('d-none'); // Hide image skeleton container

            if (book.externalLinkUrl) {
                const link = document.createElement('a');
                link.href = book.externalLinkUrl;
                link.target = '_blank';
                if (!bookImage.parentNode.isEqualNode(link)) {
                    bookImage.parentNode.insertBefore(link, bookImage);
                    link.appendChild(bookImage);
                }
            }
        } else {
            // If no thumbnail, hide the whole image area
            bookImage.parentNode.parentNode.style.display = 'none';
        }

        // --- Text Handling ---
        // Directly setting innerHTML will replace all child nodes, including the skeletons.
        document.getElementById('book-title').innerHTML = book.title;
        document.getElementById('book-author').innerHTML = book.author;
        document.getElementById('book-isbn').innerHTML = book.isbn;
        document.getElementById('book-description').innerHTML = book.description;
    }

    function renderTalksSkeleton(count = 6) {
        const skeletonHTML = Array(count).fill(0).map(() => `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="skeleton skeleton-text" style="width: 80%;"></div>
                    <div class="skeleton skeleton-text" style="width: 60%;"></div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="skeleton skeleton-text" style="width: 30%;"></div>
                        <div class="d-flex">
                            <div class="skeleton skeleton-text me-3" style="width: 50px;"></div>
                            <div class="skeleton skeleton-text" style="width: 50px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        talksContainer.innerHTML = skeletonHTML;
    }

    function fetchTalks(bookId, page) {
        currentPage = page;
        renderTalksSkeleton(); // Show skeleton UI first

        fetch(`/api/talks?bookId=${bookId}&page=${page}&size=6&sort=createdAt,desc`)
            .then(response => response.json())
            .then(data => {
                if (data && data.content) {
                    renderTalks(data.content);
                    renderTalksPagination(data.page);
                } else {
                    talksContainer.innerHTML = '<p class="text-muted">ì‘ì„±ëœ ë¶í†¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    renderTalksPagination({totalPages: 0}); // Clear pagination
                }
            })
            .catch(error => {
                console.error('Error fetching talks:', error);
                talksContainer.innerHTML = '<div class="alert alert-danger">ë¶í†¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            });
    }

    function renderTalks(talks) {
        if (talks.length === 0) {
            talksContainer.innerHTML = '<p class="text-muted">ì‘ì„±ëœ ë¶í†¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        talksContainer.innerHTML = talks.map(talk => `
            <div class="card mb-2">
                <div class="card-body">
                    <p class="card-text talk-content-text">${talk.content}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">${new Date(talk.createdAt).toLocaleString()}</small>
                        <div class="reaction-buttons-container">
                            <span class="reaction-btn me-3 ${talk.didILike ? 'reacted' : ''}" data-talk-id="${talk.id}" data-reaction-type="LIKE" data-reacted="${talk.didILike}">
                                ğŸ‘ <span class="count">${talk.like_count}</span>
                            </span>
                            <span class="reaction-btn ${talk.didISupport ? 'reacted' : ''}" data-talk-id="${talk.id}" data-reaction-type="SUPPORT" data-reacted="${talk.didISupport}">
                                â¤ï¸ <span class="count">${talk.support_count}</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderTalksPagination(page) {
        talksPaginationContainer.innerHTML = '';
        if (page.totalPages <= 1) return;

        const ul = document.createElement('ul');
        ul.className = 'pagination justify-content-center';

        if (page.number > 0) {
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item';
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${page.number - 1}">ì´ì „</a>`;
            ul.appendChild(prevLi);
        }

        const maxPagesToShow = 10;
        let startPage = Math.max(0, page.number - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(page.totalPages - 1, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(0, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === page.number ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i + 1}</a>`;
            ul.appendChild(li);
        }

        if (page.number < page.totalPages - 1) {
            const nextLi = document.createElement('li');
            nextLi.className = 'page-item';
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${page.number + 1}">ë‹¤ìŒ</a>`;
            ul.appendChild(nextLi);
        }

        talksPaginationContainer.appendChild(ul);
    }

    talksPaginationContainer.addEventListener('click', function (e) {
        if (e.target.tagName === 'A' && e.target.dataset.page) {
            e.preventDefault();
            const page = parseInt(e.target.dataset.page, 10);
            fetchTalks(bookId, page);
        }
    });

    talksContainer.addEventListener('click', function (e) {
        const target = e.target.closest('.reaction-btn');
        if (target) {
            const talkId = target.dataset.talkId;
            const reactionType = target.dataset.reactionType;
            const hasReacted = target.dataset.reacted === 'true';

            handleReactionClick(target, talkId, reactionType, hasReacted);
        }
    });

    function handleReactionClick(element, talkId, reactionType, hasReacted) {
        const method = hasReacted ? 'DELETE' : 'POST';
        fetch(`/api/reactions`, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({type: reactionType, talkId: talkId})
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        return;
                    }
                    throw new Error('ë¦¬ì•¡ì…˜ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                const countSpan = element.querySelector('.count');
                let currentCount = parseInt(countSpan.textContent, 10);
                if (hasReacted) {
                    element.classList.remove('reacted');
                    element.dataset.reacted = 'false';
                    countSpan.textContent = currentCount - 1;
                } else {
                    element.classList.add('reacted');
                    element.dataset.reacted = 'true';
                    countSpan.textContent = currentCount + 1;
                }
            })
            .catch(error => {
                console.error('Error processing reaction:', error);
                alert(error.message);
                fetchTalks(bookId, currentPage);
            });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
