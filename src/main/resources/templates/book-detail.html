<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Book Detail - Quiet Chatter</title>
    <link href="/images/quiet-chatter-icon.png" rel="icon" type="image/png">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .book-detail-container {
            background-color: #ffffff; /* White background */
            padding: 1.5rem; /* Add some padding */
            border-radius: 0.5rem; /* Rounded corners */
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* Subtle shadow */
            margin-top: 2rem;
        }

        .book-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
        }

        .book-info h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .book-info p {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .book-info .description {
            margin-top: 1.5rem;
            line-height: 1.6;
        }

        /* Media query for mobile responsiveness */
        @media (max-width: 767.98px) {
            .book-info h1 {
                font-size: 1.75rem; /* Smaller font size for mobile */
            }

            .book-detail-container {
                margin-top: 1rem;
            }
        }

        .booktalk-section {
            background-color: #ffffff; /* White background */
            padding: 1.5rem; /* Add some padding */
            border-radius: 0.5rem; /* Rounded corners */
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* Subtle shadow */
        }

        .reacted {
            font-weight: bold;
            color: #007bff; /* Bootstrap primary blue */
        }

        .reaction-btn {
            cursor: pointer;
            user-select: none; /* Prevent text selection on click */
            border: 1px solid #ced4da; /* Add a border */
            padding: 0.25rem 0.5rem; /* Add some padding */
            border-radius: 0.25rem; /* Rounded corners */
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Add the common search component -->
    <div th:replace="~{fragments/search :: book-search}"></div>

    <div class="book-detail-container">
        <h2 class="mb-3">ë„ì„œ ìƒì„¸ì •ë³´</h2>
        <div class="row">
            <!-- Explicitly stack on mobile -->
            <div class="col-12 col-md-4 text-center">
                <img alt="Book cover" class="book-image" id="book-image" src="">
            </div>
            <!-- Add margin-top for mobile stacking -->
            <div class="col-12 col-md-8 book-info mt-3 mt-md-0">
                <h1 id="book-title"></h1>
                <p><strong>ì €ì:</strong> <span id="book-author"></span></p>
                <p><strong>ISBN:</strong> <span id="book-isbn"></span></p>
                <p class="description" id="book-description"></p>
            </div>
        </div>
    </div>

    <!-- BookTalk Section -->
    <div class="booktalk-section mt-5">
        <h2>ë¶í†¡ <small class="text-muted">BookTalk</small></h2>

        <!-- Talk Post Form -->
        <form class="mt-4 mb-4" id="talk-form">
            <div class="mb-3">
                <textarea class="form-control" id="talk-content" maxlength="250" placeholder="ë¶í†¡ì„ ë‚¨ê²¨ì£¼ì„¸ìš”... (ìµœëŒ€ 250ì)"
                          required rows="3"></textarea>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <!-- Replaced "ë¹„ë°€ê¸€" checkbox with clock icon and tooltip -->
                <span class="text-muted" data-bs-placement="top" data-bs-toggle="tooltip"
                      title="ì´ ê¸€ì€ 12ê°œì›” í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€ë©ë‹ˆë‹¤.">
                    <i class="bi bi-clock"></i> <!-- Requires Bootstrap Icons -->
                    ğŸ•—
                </span>
                <button class="btn btn-primary" type="submit">ë“±ë¡</button>
            </div>
        </form>
        <hr/>

        <div class="mt-3" id="talks-container"></div>
        <nav class="mt-3" id="talks-pagination"></nav>
    </div>
</div>

<script>
    const bookId = window.location.pathname.split('/').pop();
    const talksContainer = document.getElementById('talks-container');
    const talksPaginationContainer = document.getElementById('talks-pagination');
    const talkForm = document.getElementById('talk-form');
    const talkContentInput = document.getElementById('talk-content');
    let currentPage = 0;
    // talkHiddenInput removed

    document.addEventListener('DOMContentLoaded', function () {
        if (bookId) {
            fetchBookDetails(bookId);
            fetchTalks(bookId, 0); // Fetch first page of talks
        }
        // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });

    talkForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const content = talkContentInput.value;
        // hidden variable removed

        if (content) {
            // Calculate hidden timestamp (current UTC time + 12 months)
            const now = new Date();
            now.setUTCMonth(now.getUTCMonth() + 12);
            const hiddenTimestamp = now.toISOString(); // ISO 8601 format for API

            postTalk(bookId, content, hiddenTimestamp);
        }
    });

    function postTalk(bookId, content, hiddenTimestamp) {
        fetch('/api/talks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                bookId: bookId,
                content: content,
                hidden: hiddenTimestamp // Use the calculated timestamp
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || 'ë¶í†¡ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.')
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Talk posted successfully:', data);
                // Clear the form
                talkContentInput.value = '';
                // Refresh the talk list to the first page
                fetchTalks(bookId, 0);
            })
            .catch(error => {
                console.error('Error posting talk:', error);
                alert(error.message);
            });
    }

    function fetchBookDetails(bookId) {
        fetch(`/api/books/${bookId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Book not found');
                }
                return response.json();
            })
            .then(book => {
                renderBookDetail(book);
            })
            .catch(error => {
                console.error('Error fetching book details:', error);
                document.querySelector('.book-detail-container').innerHTML = '<div class="alert alert-danger">ì±… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            });
    }

    function renderBookDetail(book) {
        document.title = book.title + ' - Quiet Chatter';

        const bookImage = document.getElementById('book-image');
        if (book.thumbnailImageUrl) {
            bookImage.src = book.thumbnailImageUrl;
            bookImage.alt = book.title;
            // Wrap image with a link
            if (book.externalLinkUrl) {
                const link = document.createElement('a');
                link.href = book.externalLinkUrl;
                link.target = '_blank';
                // Insert link before image, then move image inside link
                bookImage.parentNode.insertBefore(link, bookImage);
                link.appendChild(bookImage);
            }
        } else {
            bookImage.style.display = 'none';
        }

        document.getElementById('book-title').textContent = book.title;
        document.getElementById('book-author').textContent = book.author;
        document.getElementById('book-isbn').textContent = book.isbn;
        document.getElementById('book-description').textContent = book.description;
    }

    function fetchTalks(bookId, page) {
        currentPage = page;
        fetch(`/api/talks?bookId=${bookId}&page=${page}&size=6&sort=createdAt,desc`)
            .then(response => response.json())
            .then(data => {
                if (data && data.content) {
                    renderTalks(data.content);
                    renderTalksPagination(data.page);
                }
            })
            .catch(error => {
                console.error('Error fetching talks:', error);
                talksContainer.innerHTML = '<div class="alert alert-danger">ë¶í†¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            });
    }

    function renderTalks(talks) {
        if (talks.length === 0) {
            talksContainer.innerHTML = '<p class="text-muted">ì‘ì„±ëœ ë¶í†¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        talksContainer.innerHTML = talks.map(talk => `
            <div class="card mb-2">
                <div class="card-body">
                    <p class="card-text">${talk.content}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">${new Date(talk.createdAt).toLocaleString()}</small>
                        <div>
                            <span class="reaction-btn me-3 ${talk.didILike ? 'reacted' : ''}" data-talk-id="${talk.id}" data-reaction-type="LIKE" data-reacted="${talk.didILike}">
                                ğŸ‘ <span class="count">${talk.like_count}</span>
                            </span>
                            <span class="reaction-btn ${talk.didISupport ? 'reacted' : ''}" data-talk-id="${talk.id}" data-reaction-type="SUPPORT" data-reacted="${talk.didISupport}">
                                â¤ï¸ <span class="count">${talk.support_count}</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderTalksPagination(page) {
        talksPaginationContainer.innerHTML = '';
        if (page.totalPages <= 1) return;

        const ul = document.createElement('ul');
        ul.className = 'pagination justify-content-center';

        // Previous button
        if (page.number > 0) { // Check if it's not the first page
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item';
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${page.number - 1}">ì´ì „</a>`;
            ul.appendChild(prevLi);
        }

        // Page numbers
        const maxPagesToShow = 10;
        let startPage = Math.max(0, page.number - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(page.totalPages - 1, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(0, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === page.number ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i + 1}</a>`;
            ul.appendChild(li);
        }

        // Next button
        if (page.number < page.totalPages - 1) { // Check if it's not the last page
            const nextLi = document.createElement('li');
            nextLi.className = 'page-item';
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${page.number + 1}">ë‹¤ìŒ</a>`;
            ul.appendChild(nextLi);
        }

        talksPaginationContainer.appendChild(ul);
    }

    talksPaginationContainer.addEventListener('click', function (e) {
        if (e.target.tagName === 'A' && e.target.dataset.page) {
            e.preventDefault();
            const page = parseInt(e.target.dataset.page, 10);
            fetchTalks(bookId, page);
        }
    });

    talksContainer.addEventListener('click', function (e) {
        const target = e.target.closest('.reaction-btn');
        if (target) {
            const talkId = target.dataset.talkId;
            const reactionType = target.dataset.reactionType;
            const hasReacted = target.dataset.reacted === 'true';

            handleReactionClick(target, talkId, reactionType, hasReacted);
        }
    });

    function handleReactionClick(element, talkId, reactionType, hasReacted) {
        const method = hasReacted ? 'DELETE' : 'POST';
        fetch(`/api/talks/${talkId}/reactions`, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({type: reactionType})
        })
            .then(response => {
                if (!response.ok) {
                    // 401 Unauthorized, 403 Forbidden etc.
                    if (response.status === 401 || response.status === 403) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        return;
                    }
                    throw new Error('ë¦¬ì•¡ì…˜ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                // Optimistically update UI
                const countSpan = element.querySelector('.count');
                let currentCount = parseInt(countSpan.textContent, 10);

                if (hasReacted) {
                    element.classList.remove('reacted');
                    element.dataset.reacted = 'false';
                    countSpan.textContent = currentCount - 1;
                } else {
                    element.classList.add('reacted');
                    element.dataset.reacted = 'true';
                    countSpan.textContent = currentCount + 1;
                }
            })
            .catch(error => {
                console.error('Error processing reaction:', error);
                alert(error.message);
                // Re-fetch to reset state on error
                fetchTalks(bookId, currentPage);
            });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
