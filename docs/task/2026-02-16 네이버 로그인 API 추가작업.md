# 에이전트 작업 절차

1. 아래 `## 개발자 요구사항` 섹션을 바탕으로 코드 베이스를 검토하고 작업을 준비한다.
2. 만약 마지막 섹션이 `## 개발자 요구사항 수정` 또는 `## 개발자 검토답변` 등 개발자의 섹션이라면 중간을 건너뛰고 해당 부분부터 작업하도록 한다.
3. 개발자의 의사결정이 필요한 내용이 있다면 문의할 내용을 이 파일의 마지막에 `## 에이전트 검토요청`으로 섹션을 추가하고 작업을 종료한다.
4. 작업을 완료한 경우 내용 이 파일의 마지막에 `## 에이전트 작업수행내용 : {yyyy-MM-dd HH : MM}` 섹션을 추가하고 작업한 상세 내용을 작성한다.
5. 그밖의 일반적인 작업지침은 [ai_agent_guide.md](/docs/guide/ai_agent_guide.md) 을 확인 후 작업한다.

## 개발자 검토요청사항

- 코딩을 요청하기전까지 본 파일안에서 설계에 집중한다.

- OAUTH2 네이버 계정을 통한 로그인을 도입하고자 한다.

- https://developers.naver.com/docs/login/api/api.md 에 해당 로그인 api 명세가 있다.

- 엔드포인트는 /v1/auth/login/naver로 하려고한다.

- 클라이언트와 협력이 필요하다. 로컬경로는 /Users/maskun/WebstormProjects/quiet-chatter-front-end 에 위치하고 있으니 이를 참고한다.

- 먼저 전체적인 클라이언트-서버간 인터페이스 설계를 진행한다.

- 해당 설계를 진행하고 검토답변을 한다.

- 추가 문의가 필요한 내용이 있으면 기술한다.



## 에이전트 검토요청: 인터페이스 설계안



네이버 로그인을 위한 클라이언트-서버 간 인터페이스 및 흐름 설계안입니다.



### 1. 인증 흐름 (Authentication Flow)

1. **[Client]** 사용자가 "네이버 로그인" 버튼 클릭.

2. **[Client]** 네이버 로그인 URL로 리다이렉트 (Client ID, Redirect URI, State 포함).

3. **[Naver]** 사용자가 로그인 및 동의 완료 후 Redirect URI(Client)로 `code`와 `state`를 가지고 리다이렉트.

4. **[Client]** 콜백 페이지에서 `code`와 `state`를 추출하여 서버 API(`POST /v1/auth/login/naver`) 호출.

5. **[Server]** 받은 `code`를 사용하여 네이버 서버에 `access_token` 요청.

6. **[Server]** 네이버 `access_token`으로 사용자 프로필 정보 조회.

7. **[Server]** 조회된 정보(email, id 등)를 바탕으로 회원가입 또는 로그인 처리.

8. **[Server]** 자체 JWT(access_token, refresh_token)를 생성하여 쿠키(HttpOnly)에 담아 응답.

9. **[Client]** 성공 응답을 받은 후 `refreshUser()` 호출하여 유저 정보 동기화 및 메인 페이지로 이동.



### 2. API 명세 (Server API)

- **Endpoint:** `POST /v1/auth/login/naver`

- **Request Body:**

  ```json

  {

    "code": "string",

    "state": "string"

  }

  ```

- **Response:**

  - **Success (200 OK):** 자체 토큰이 쿠키에 설정됨.

    ```json

    {

      "isNewMember": boolean,

      "nickname": "string"

    }

    ```

  - **Failure (401 Unauthorized):** 네이버 인증 실패 시.



### 3. 데이터 모델 변경 (DB/Entity)

- **Member Entity 추가 필드:**

  - `provider`: "NAVER" (Enum: OauthProvider)

  - `providerId`: 네이버에서 제공하는 고유 식별자 (string)

  - `email`: 네이버 계정 이메일 (선택 사항)



### 4. 고려 사항 및 질문

- **기존 게스트 계정 처리:** 현재 사용자가 게스트로 이용 중이다가 네이버 로그인을 했을 때, 기존 게스트의 활동 내역(톡, 반응 등)을 네이버 계정으로 이전(Merge)할 필요가 있을까요? 아니면 단순히 새로운 계정으로 취급할까요?

- **Redirect URI:** 프론트엔드에서 네이버 로그인을 마친 후 돌아올 콜백 URL을 확정해야 합니다. (예: `http://localhost:5173/auth/naver/callback`)

- **네이버 애플리케이션 설정:** Client ID와 Secret 키를 서버 환경 변수(`application.yml`)에 등록해야 합니다.



해당 설계안에 대해 검토 부탁드립니다.

## 개발자 검토 답변
- 기존 게스트 계정의 활동의 이전여부: 하지 않는다.
- 콜백 path는 `https://quiet-chatter.com/auth/login/naver/callback` 로한다. 로컬경로는 `http://localhost:5173/auth/login/naver/callback` 와같다.
- 네이버 애플리케이션 설정은 이미 되어있으며 
```yaml
naver:
  api:
    client-id: hidden
    client-secret: hidden
```

위 내용을 검토하고 추가 필요한 검토사항이 없는지 확인한다.

## 에이전트 검토요청: 상세 기술 설계안

개발자 답변을 바탕으로 한 상세 기술 설계안입니다. 추가적인 문의 사항은 없으며, 본 설계안 검토 후 승인 시 구현을 시작하도록 하겠습니다.

### 1. 백엔드 설계 (Server-side)

#### 1.1 데이터 모델 변경
- `maskun.quietchatter.member.domain.Member` 엔터티 수정:
    - `provider` (Enum: `OauthProvider` { `NONE`, `NAVER` }) 필드 추가. 기존 게스트/일반 회원은 `NONE`.
    - `providerId` (String) 필드 추가. 네이버 고유 식별자 저장.
    - `email` (String) 필드 추가.
- Flyway 마이그레이션 스크립트 작성 (`V3__add_oauth_fields.sql`).

#### 1.2 네이버 API 연동 (`NaverClient`)
- `maskun.quietchatter.security.adaptor.out.NaverClient` (New):
    - `RestClient`를 사용하여 네이버 토큰 발급 API(`https://nid.naver.com/oauth2.0/token`) 호출.
    - 네이버 프로필 조회 API(`https://openapi.naver.com/v1/nim/getUserProfile.xml`) 호출 (JSON 응답 사용).

#### 1.3 서비스 로직 (`AuthMemberService`)
- `AuthMemberService.loginWithNaver(code, state)` 메서드 추가:
    - 네이버 프로필 정보 획득.
    - `providerId`로 기존 회원 조회.
    - 미가입 시 신규 회원 가입 처리 (`Role.MEMBER`, `Status.ACTIVE`).
    - 가입 시 `MemberRegistrable` 인터페이스 확장 필요.
- 로그인 완료 후 자체 `access_token`, `refresh_token` 생성 및 쿠키 설정.

### 2. 프론트엔드 설계 (Client-side)

#### 2.1 환경 변수 설정 (`.env`)
- `VITE_NAVER_CLIENT_ID`: 네이버 애플리케이션 클라이언트 ID
- `VITE_NAVER_REDIRECT_URI`: `http://localhost:5173/auth/login/naver/callback` (개발 환경용)

#### 2.2 API 연동 (`src/api/api.ts`)
- `loginWithNaver(code, state)` 함수 추가: `POST /v1/auth/login/naver` 호출.

#### 2.3 콜백 컴포넌트 (`src/pages/NaverCallback.tsx`)
- URL 파라미터에서 `code`, `state` 추출.
- `loginWithNaver` 호출 후 성공 시 `refreshUser()` 실행 및 메인 페이지 리다이렉트.

### 3. 인증 처리 시나리오
- **기존 게스트 세션 존재 시:** 네이버 로그인 성공 시 기존 게스트 정보는 무시되고, 서버에서 새로 발급한 네이버 사용자용 토큰이 쿠키를 덮어씁니다. (개발자 요청에 따라 Merge 작업은 수행하지 않음)
- **CSRF 방지:** 네이버 로그인 요청 시 생성한 `state` 값을 프론트엔드 세션 스토리지에 임시 저장하고, 콜백 시 서버로 전송하여 검증에 활용.

위 설계안에 대해 추가 의견이 없으시면 구현을 진행하겠습니다.

## 개발자 답변

- Member` 엔터티 수정:` `email` 은 수집하지 않으므로 제외한다.



그밖의 사항은 검토완료되었으므로 코딩작업을 시작한다.



## 에이전트 작업수행내용 : 2026-02-16 13:20

### 백엔드 (Server)

- `Member` 엔터티에 `OauthProvider`와 `providerId` 필드 추가.

- Flyway 마이그레이션 (`V3__member_oauth_fields.sql`) 작성.

- `NaverClient` 구현: 네이버 토큰 획득 및 프로필 조회 API 연동.

- `AuthMemberService.loginWithNaver` 구현: 네이버 계정 기반 가입/로그인 로직 완성.

- `AuthLoginApi` 추가: `POST /v1/auth/login/naver` 엔드포인트 구현 및 JWT 발급 처리.

- 컴파일 에러 수정 및 클래스 가시성(public) 조정.



### 프론트엔드 (Client)

- `api.ts`에 `loginWithNaver` API 함수 추가.

- `NaverCallback.tsx` 페이지 구현: 네이버 인증 코드 처리 및 로그인 완료 로직.

- `App.tsx` 라우팅 설정: `/auth/login/naver/callback` 경로 추가.

- `Header.tsx` 수정: 로그인 버튼 추가 및 게스트/회원 상태별 UI 대응.

- API 호출 경로를 `/api/v1`으로 통일하여 백엔드와 맞춤.


## 개발자 추가요청사항
- OAUTH2 유저 조회성능향상을 위해서 Member 엔티티에 추가한 컬럼에 대한 인덱스 추가
- AuthLoginApi 와 관련한 수정 : 성공코드만 반환하고 응답바디를 담지 않음
  - 로그인 성공시에는 statusCode 204 만을 반환한다. 이후 프론트 앤트에서는 로그인정보를 /v1/auth/me 로 확인하도록 한다.

## 에이전트 작업수행내용 : 2026-02-16 13:40
- **Member 인덱스 추가**: `V4__add_member_oauth_index.sql` Flyway 스크립트 작성하여 `provider`, `provider_id` 복합 인덱스 생성.
- **AuthLoginApi 수정**: `loginWithNaver` 엔드포인트 응답 코드를 `200 OK` -> `204 No Content`로 변경하고 응답 바디 제거.
- **NaverLoginResponse 삭제**: 불필요해진 DTO 클래스 삭제.
- **프론트엔드 api.ts 수정**: `loginWithNaver` 함수의 반환 타입을 `void`로 변경.

## 개발자 추가 요청사항
- 스크립트 병합
@src/main/resources/db/migration/V4__add_member_oauth   
_index.sql 를 @src/main/resources/db/migration/V3__member_oauth_fie   
lds.sql 에 병합 시키도록한다.          
- 지금까지의 네이버 로그인과 관련한 커밋을 모아서 하나로 squash하도록 한다.

## 에이전트 작업수행내용 : 2026-02-16 13:50

- **스크립트 병합**: `V4`의 인덱스 생성 쿼리를 `V3__member_oauth_fields.sql`로 통합하고 `V4` 파일 삭제.
- **커밋 Squash**: 네이버 로그인 관련 모든 작업(백엔드, 프론트엔드, DB, 문서)을 하나의 커밋(`feat(auth): 네이버 OAUTH2 로그인 기능 추가`)으로 통합 완료.
