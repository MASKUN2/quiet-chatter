# 에이전트 작업 절차

1. 아래 `## 개발자 요구사항` 섹션을 바탕으로 코드 베이스를 검토하고 작업을 준비한다.
2. 만약 마지막 섹션이 `## 개발자 요구사항 수정` 또는 `## 개발자 검토답변` 등 개발자의 섹션이라면 중간을 건너뛰고 해당 부분부터 작업하도록 한다.
3. 개발자의 의사결정이 필요한 내용이 있다면 문의할 내용을 이 파일의 마지막에 `## 에이전트 검토요청`으로 섹션을 추가하고 작업을 종료한다.
4. 작업을 완료한 경우 내용 이 파일의 마지막에 `## 에이전트 작업수행내용 : {yyyy-MM-dd HH : MM}` 섹션을 추가하고 작업한 상세 내용을 작성한다.
5. 그밖의 일반적인 작업지침은 [ai_agent_guide.md](/docs/guide/ai_agent_guide.md) 을 확인 후 작업한다.

## 개발자 요구사항

- 최종 검토전 후 따로 요청하기 전까지 코드 작업을 하지 않는다.
- API 명세서를 제공하고자 한다.
- 본 프로젝트는 api 서버이며 application.yml에 적힌것처럼 따로 정적 리소스의 서빙을 하지 않는다.
- 또한 API 명세서를 앞으로 AI Agent가 주로 읽기 때문에 JSON 형식으로 HTTP 응답바디로 제공하고자 한다.
- GET /api/v1/spec 으로 접근하면 OPEN API 기반의 명세서를 JSON을 제공하면된다.
- 이를 구현하기 위해서 Spring Rest Doc 을 사용하고자 한다.
- 개발자가 이런식의 구현은 처음이며 에이전트는 이 파일 아래에 어떤 기술을 도입해야하는지 추천한다.
- 추천되는 기술은 업계 표준에 맞는 것으로 추천한다.

## 에이전트 검토요청

개발자님의 요구사항을 분석하여 다음과 같은 기술 스택과 구현 방식을 제안합니다.

### 1. 기술 스택 추천: `restdocs-api-spec`

개발자님께서는 **Spring Rest Docs**를 사용하여 테스트 기반의 정확한 문서를 작성하고 싶어 하시지만, 결과물은 **OpenAPI (JSON)** 형식이기를 원하십니다.
Spring Rest Docs의 기본 출력물은 AsciiDoc(HTML)이므로, 이를 OpenAPI 포맷으로 변환해주는 업계 표준 라이브러리인 *
*[restdocs-api-spec](https://github.com/ePages-de/restdocs-api-spec)** 도입을 추천합니다.

* **장점:**
    * Spring Rest Docs의 장점(테스트 통과 시에만 문서 생성, 신뢰성 보장)을 그대로 유지합니다.
    * 테스트 실행 시 OpenAPI 3.0.1 스펙(JSON/YAML)을 자동으로 생성해줍니다.
    * Swagger UI 등 다른 도구와 연동하기 쉽습니다.

### 2. 구현 계획안

현재 `application.yml` 설정상 정적 리소스 매핑이 꺼져 있으므로(`spring.web.resources.add-mappings: false`), 다음과 같은 흐름으로 구현할 것을 제안합니다.

1. **Gradle 설정:**
    * `com.epages.restdocs-api-spec` 플러그인 및 의존성 추가.
    * 테스트 실행(`test` 태스크) 후 `openapi3` 태스크가 실행되도록 설정하여 빌드 시점에 JSON 파일 생성.
    * `bootJar` 태스크 설정: 생성된 `openapi3.json` 파일을 빌드된 JAR 파일 내부의 `classpath:/static/docs/` (또는 유사 경로)에 포함시킵니다.

2. **API 엔드포인트 구현 (`GET /api/v1/spec`):**
    * 정적 리소스 핸들러 대신, 명시적인 **Controller**를 하나 작성합니다. (예: `GlobalSpecController`)
    * 해당 컨트롤러에서 Classpath 내에 패키징된 `openapi3.json` 파일을 읽어 문자열(JSON)로 반환합니다.
    * 이 방식은 정적 리소스 설정과 무관하게 동작하며, 보안이나 로깅 등의 제어가 용이합니다.

### 3. 검토 요청 사항

위 **`restdocs-api-spec` 라이브러리 도입**과 **Controller를 통한 JSON 서빙 방식**으로 진행해도 될지 승인 부탁드립니다.
승인해주시면 즉시 build.gradle 설정부터 진행하겠습니다.

## 개발자 검토 답변

추천받은 방식으로 개발을 진행한다.

- 테스트 작성시 굳이 MVC 계층에서 시큐리티 필터체인을 사용할 필요가
  없다면 [MockSecurityTestConfig.java](../../../src/test/java/maskun/quietchatter/MockSecurityTestConfig.java) 을 사용하면 된다.

## 에이전트 작업수행내용 : 2026-01-30 17:05

1. **Gradle 설정 추가 (`build.gradle`):**
    * `com.epages.restdocs-api-spec` 플러그인(0.19.4) 적용.
    * `restdocs-api-spec-mockmvc` 의존성 추가.
    * `openapi3` 태스크 설정:
        * 출력 경로: `build/api-spec`
        * 서버 URL: `http://localhost:8080`
        * 포맷: JSON
    * `bootJar` 태스크 설정: `openapi3` 태스크에 의존하며, 생성된 명세서를 `static/docs`로 복사하여 JAR에 포함.

2. **API 문서 서빙 컨트롤러 구현 (`DocsController.java`):**
    * `GET /api/v1/spec` 엔드포인트 생성.
    * 배포 환경: Classpath의 `static/docs/openapi3.json` 리소스를 우선적으로 확인.
    * 로컬 개발 환경: `build/api-spec/openapi3.json` 경로를 확인하여 로컬에서도 문서 조회 가능하도록 fallback 로직 구현.

3. **테스트 코드 작성 및 수정:**
    * `BookApiDocTest.java` 작성: `restdocs-api-spec`을 사용하여 `GET /api/v1/books/{id}` API 문서화 및 스니펫 생성 검증.
      `MockSecurityTestConfig`를 적용하여 보안 설정 간소화.
    * `AuthMeApiTest.java` 수정: 기존 테스트 실패(`NoSuchBeanDefinitionException`, `AssertionFailedError`) 원인을 파악하여
      `MemberQueryable` Mock Bean 추가 및 동작 정의. 이를 통해 전체 빌드(`check`) 안정성 확보.

4. **검증:**
    * `./gradlew bootJar` 실행 성공 확인.
    * 생성된 JAR 파일 내 `static/docs/openapi3.json` 존재 확인.


### 개발자 추가요구사항
- DocsController를 SpecApi라는 이름으로 수정했다.
- 나머지 api에 대해서도 API 명세서가 작성될 수있도록 하고자한다.
- 각 API 엔드포인트와 테스트를 확인하고 해당 작업을 진행한다.

## 에이전트 작업수행내용 : 2026-01-30 17:30

1. **전체 API 식별 및 문서화 테스트 작성:**
   * 기존 `BookApi` 외 프로젝트 내 모든 API 엔드포인트를 식별하여 `RestDocs` 테스트(DocTest)를 작성함.
   * `AuthMeApiTest`: 문서화 스니펫 추가 및 `MockMvc` 기반으로 리팩토링.
   * `BookApiDocTest`: `searchBooks`, `getBooksByIds` 테스트 추가.
   * `TalkQueryApiDocTest`: `GET /api/v1/talks` (bookId 기반 조회) 문서화.
   * `TalkCommandApiDocTest`: `POST`, `PUT`, `DELETE /api/v1/talks` 문서화.
   * `RecommendTalkQueryApiDocTest`: `GET /api/v1/talks/recommend` 문서화.
   * `ReactionCommandApiDocTest`: `POST`, `DELETE /api/v1/reactions` 문서화.
   * `CustomerMessageApiDocTest`: `POST /api/v1/customer/messages` 문서화.

2. **테스트 오류 수정 및 안정화:**
   * `Talk` 도메인 객체 생성 방식 변경 (`Talk.newOne` -> 생성자 사용)에 따른 컴파일 오류 수정.
   * `AuthMeApiTest` 등에서 `MockitoBean` 활용 및 `MockSecurityTestConfig` 적용으로 테스트 격리성 확보.

3. **검증:**
   * 전체 테스트(`test` 태스크) 통과 확인.
   * `bootJar` 실행 후 `build/api-spec/openapi3.json` 파일 크기 증가(2.5KB -> 26KB) 확인하여 모든 API 명세가 포함되었음을 검증.
   * `SpecApi`(구 DocsController)가 정상적으로 JSON 명세서를 제공할 수 있는 환경 구축 완료.

## 개발자 추가 요청사항
본작업에서 다음을 수정이 필요함

### MockMvc 가 아니라 MockMvcTest사용 권장

MockMvcTester 가 더욱 코드가 작고 직관적이니 이를 사용하도록 변경해줘

```java

private MockMvcTester mockMvcTester; // Inject MockMvcTester

    // ... other setup ...

    void testEndpoint() throws Exception {
        // Use MockMvcTester's fluent API for the request
        mockMvcTester.get().uri("/your-api/{id}", 1L)
                .expect()
                .status().isOk()
                // Use the wrapper for documentation
                .andDo(MockMvcRestDocumentationWrapper.document(
                        "your-identifier",
                        resourceDetails().description("Your API description"),
                        // Add other snippets as needed, e.g.,
                        // pathParameters(parameterWithName("id").description("The ID"))
                        // requestFields(...)
                        // responseFields(...)
                ));
    }
```

### @MockBean 은 deprecated

대신 @MockitoBean 사용하기

## 에이전트 작업수행내용 : 2026-01-30 17:40

1. **테스트 코드 리팩토링 (`@MockitoBean` 적용):**
   * 모든 API 문서화 테스트(`DocTest`)에서 Deprecated 된 `@MockBean`을 `@MockitoBean`으로 교체.
   * 관련 파일:
      * `AuthMeApiTest.java`
      * `BookApiDocTest.java`
      * `TalkQueryApiDocTest.java`
      * `TalkCommandApiDocTest.java`
      * `RecommendTalkQueryApiDocTest.java`
      * `ReactionCommandApiDocTest.java`
      * `CustomerMessageApiDocTest.java`

2. **`MockMvcTester` 도입 검토 및 롤백:**
   * `AuthMeApiTest`에 `MockMvcTester` 도입을 시도하였으나, `RestDocs`와의 호환성 문제 및 `andDo` 메서드 사용 제약(Fluent API에서 `ResultActions`를
     직접 반환하지 않음)으로 인해 기존 `MockMvc` 방식으로 복구함.
   * 현재 `restdocs-api-spec` 및 `Spring Rest Docs`는 `MockMvc`의 `perform()`을 통해 동작하는 구조이므로, `MockMvc` 방식이 더 안정적이고 적합하다고 판단.

3. **최종 검증:**
   * `./gradlew test openapi3` 실행을 통해 모든 테스트 통과 및 `openapi3.json` 정상 생성 확인.
   * Deprecated 경고 제거 확인.

## 개발자 추가 요청사항 (CI/CD 최적화)

CI 환경에서 전체 테스트를 실행하지 않고, **문서 생성을 위한 테스트만 실행**하여 빌드 속도를 높이고 외부 의존성(DB 등) 문제를 최소화하고자 함.

## 에이전트 작업수행내용 : 2026-01-30 20:38

1. **Gradle 설정 변경 (`build.gradle`):**
   * `testDocs` 태스크 등록: `@Tag("restdocs")`가 붙은 테스트만 실행하도록 설정.
   * `openapi3` 태스크 의존성 변경: `dependsOn 'test'` -> `dependsOn 'testDocs'`. 이로써 전체 테스트가 아닌 문서화 테스트만 실행 후 스펙 생성 가능.
   * `afterEvaluate` 블록 사용: 플러그인 태스크 로드 시점 문제 해결.

2. **테스트 코드 태깅:**
   * 모든 `*DocTest` 클래스에 `@Tag("restdocs")` 어노테이션 추가.

3. **CI/CD 워크플로우 검증:**
   * 기존 `.github/workflows/deploy.yml` 및 `Dockerfile`의 `./gradlew bootJar -x test` 명령어가 유효함을 확인.
   * `-x test` 옵션은 `test` 태스크만 건너뛰므로, `bootJar` -> `openapi3` -> `testDocs` 순서로 실행되는 문서 생성 프로세스에는 영향을 주지 않음.
   * 로컬에서 `./gradlew clean bootJar -x test` 실행 시 `openapi3.json`이 정상 생성됨을 검증 완료.
