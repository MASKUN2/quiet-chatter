# 에이전트 작업 절차

1. 아래 `## 개발자 요구사항` 섹션을 바탕으로 코드 베이스를 검토하고 작업을 준비한다.
2. 만약 마지막 섹션이 `## 개발자 요구사항 수정` 또는 `## 개발자 검토답변` 등 개발자의 섹션이라면 중간을 건너뛰고 해당 부분부터 작업하도록 한다.
3. 개발자의 의사결정이 필요한 내용이 있다면 문의할 내용을 이 파일의 마지막에 `## 에이전트 검토요청`으로 섹션을 추가하고 작업을 종료한다.
4. 작업을 완료한 경우 내용 이 파일의 마지막에 `## 에이전트 작업수행내용 : {yyyy-MM-dd HH : MM}` 섹션을 추가하고 작업한 상세 내용을 작성한다.
5. 그밖의 일반적인 작업지침은 [ai_agent_guide.md](/docs/guide/ai_agent_guide.md) 을 확인 후 작업한다.

## 개발자 요구사항

- 클라이언트를 신규 클라우드 플레어 페이지로 분리함으로 quiet-chatter.com을 프론트엔트 주소로 가져가고 있다.
- 백엔드는 서브도메인을 추가하여 api.quiet-chatter.com 으로 주소를 설정했다.
- 그로인해 백엔드에서 설정한 쿠키가 api.quiet-chatter.com에만 심어지므로 같은 도메인을 공유하는 인증 쿠키 설정을 하고자 한다.
- 우선 공통 환경의 application.yml을 두고 운영환경의 application-prod.yml을 추가하도록 한다.
- 운영환경설정에서 프로퍼티로 설정할 수 있는 옵션을 추가한다. 예를들어 쿠키의 secure 여부, samesite 설정등이 있다.
- 로컬환경에서는 prod 프로파일을 실행하지 않기 때문에 기본으로 둔다.
- 목표는 설정 파일조작과 AuthTokenService 만의 수정으로 이를 달성하는 것이다.

## 에이전트 작업수행내용 : 2026-01-31 19:39

- `src/main/resources/application.yml`에 `app.cookie` 관련 설정을 추가하여 기본값(domain: null, secure: false, same-site: Lax)을
  설정했습니다.
- `src/main/resources/application-prod.yml`을 생성하고 운영 환경 설정(domain: quiet-chatter.com, secure: true, same-site: Lax)을
  추가했습니다.
- `AuthTokenService`를 리팩토링하여 `application.yml`의 설정을 주입받도록 수정했습니다.
- `AuthTokenService`에서 쿠키 생성 시 `HttpServletResponse.addCookie()` 대신 `ResponseCookie`를 사용하여 `Set-Cookie` 헤더를 직접 추가하도록
  변경했습니다. 이를 통해 `SameSite` 및 `Domain` 속성을 지원합니다.
- `AuthTokenServiceTest`에 새로운 생성자를 반영하고, 쿠키 속성이 올바르게 설정되는지 검증하는 테스트 케이스를 추가했습니다.

## 개발자 검토사항

- 커스텀 프로퍼티를 사용했는데 이것이 업계표준인지 확인한다. 일반적으로 servlet 설정같은것을 쓰지는 않는지 확인한다. 지금까지 한 작업을 보고 업계표준방식과 비교해서 어떤것이 다르며 어떤것을 추천하는지 아래에
  답변한다.
- 따로 요청하기전까지 코드수정을 하지 않는다.

## 에이전트 검토답변

개발자님의 검토 사항에 대해 현재 구현 방식과 업계 표준(Spring Boot Best Practices)을 비교 분석하여 답변드립니다.

### 1. `server.servlet.session.cookie` 설정과의 차이점

- **`server.servlet.session.cookie.*`**: 이 설정은 **Servlet Container의 세션(JSESSIONID)**을 위한 것입니다. Spring Boot는 이 설정을 기반으로
  Tomcat/Jetty의 세션 매니저를 자동 설정합니다.
- **JWT 쿠키 (현재 구현)**: `AuthTokenService`에서 생성하는 Access/Refresh 토큰은 애플리케이션이 직접 생성하는 **커스텀 쿠키**입니다. Spring Boot는 커스텀 쿠키에
  대해 `server.servlet.session.cookie` 설정을 자동으로 적용해주지 않습니다.
- **결론**: 커스텀 쿠키를 사용한다면, 개발자가 명시적으로 속성(SameSite, Secure, Domain 등)을 코드로 설정해주어야 하므로 **별도의 설정 값을 가져오는 과정이 반드시 필요**합니다.

### 2. 업계 표준 및 일반적인 방식 비교

#### A. 커스텀 프로퍼티 사용 (현재 방식 / `app.cookie.*`) - **[보편적]**

- **방식**: JWT 토큰 전용 설정을 별도로 정의합니다.
- **장점**: 세션 설정(`JSESSIONID`)과 인증 토큰 설정을 분리하여 관리할 수 있습니다. (예: 세션은 안 쓰지만 토큰은 쓰는 경우, 혹은 수명이 다른 경우)
- **적합성**: Stateless한 JWT 인증 구조에서는 세션 설정과 무관하게 독립적으로 설정하는 것이 의미상 더 명확하므로 널리 사용됩니다.

#### B. `ServerProperties` 재사용 - **[일부 사용]**

- **방식**: `server.servlet.session.cookie` 설정을 코드에서 주입받아 JWT 쿠키 생성 시 재사용합니다.
- **장점**: 설정 파일이 간결해집니다.
- **단점**: "세션" 설정이라는 이름 때문에 의미가 혼동될 수 있으며, 세션 쿠키와 JWT 쿠키의 보안 정책을 다르게 가져가기 어렵습니다.

#### C. `@ConfigurationProperties` 사용 (Type-safe Configuration) - **[권장되는 업계 표준]**

- **방식**: `@Value`로 하나씩 주입받는 대신, 설정값을 담는 Java Class(POJO)를 만들어 바인딩합니다.
- **장점**:
    - 타입 안정성 보장 및 IDE 자동 완성 지원.
    - `AuthTokenService` 생성자가 깔끔해짐 (파라미터가 줄어듦).
    - 설정을 그룹화하여 관리 용이.

### 3. 결론 및 추천

현재 구현하신 **커스텀 프로퍼티 방식은 Stateless 아키텍처에서 올바른 접근**입니다. `server.servlet.session.cookie`를 쓰지 않은 것은 JWT의 특성상 적절한 선택이었습니다.

다만, **코드 품질(Maintainability) 측면**에서 개선할 점은 다음과 같습니다.

- **추천**: 현재 `@Value` 어노테이션을 여러 개 나열하여 주입받는 방식보다는, **`@ConfigurationProperties`를 도입하여 설정 관리 클래스(`CookieProperties` 등)로
  분리**하는 것을 추천드립니다. 이것이 Spring Boot에서 권장하는 가장 모던하고 깔끔한 패턴입니다.

**향후 진행 제안 (요청 시 수행):**

- 기존 로직은 유지하되, `@Value`들을 제거하고 `CookieProperties` 클래스를 도입하여 리팩토링.

## 개발자 검토답변

- @ConfigurationProperties 방식으로 리팩토링 진행해주세요.

## 에이전트 작업수행내용 : 2026-01-31 19:46

- `QuietChatterApplication`에 `@ConfigurationPropertiesScan`을 추가하여 프로퍼티 클래스 스캔을 활성화했습니다.
- `src/main/java/maskun/quietchatter/security/adaptor/AppCookieProperties.java` 레코드를 생성하고
  `@ConfigurationProperties("app.cookie")`를 적용하여 설정을 바인딩했습니다.
- `AuthTokenService`가 개별 `@Value` 필드 대신 `AppCookieProperties`를 주입받아 사용하도록 리팩토링했습니다.
- `AuthTokenServiceTest`를 변경된 구조에 맞게 업데이트하고 테스트를 통과했습니다.

## 개발자 추가요구사항

- @NullMark 그리고 프로퍼티 바인딩서의 NotNull을 강제해서 AuthTokenService에서 불필요한 null 체크가 없도록해주세요.

## 에이전트 작업수행내용 : 2026-01-31 19:57

- `AppCookieProperties`에서 쿠키 빌더에 설정을 적용하는 `applyTo` 메서드를 제거했습니다. 이는 프로퍼티 클래스의 책임 범위를 넘어서는 것으로 판단되어, 데이터를 전달하는 역할에만 집중하도록
  변경했습니다.
- `AuthTokenService`에서 `AppCookieProperties`의 필드들을 직접 참조하여 쿠키 설정을 적용하도록 수정했습니다.
- 기존의 모든 유효성 검사 및 설정 로직은 유지한 채 구조적인 개선을 완료했습니다.