# 에이전트 작업 절차

1. 아래 `## 개발자 요구사항` 섹션을 바탕으로 코드 베이스를 검토하고 작업을 준비한다.
2. 만약 마지막 섹션이 `## 개발자 요구사항 수정` 또는 `## 개발자 검토답변` 등 개발자의 섹션이라면 중간을 건너뛰고 해당 부분부터 작업하도록 한다.
3. 개발자의 의사결정이 필요한 내용이 있다면 문의할 내용을 이 파일의 마지막에 `## 에이전트 검토요청`으로 섹션을 추가하고 작업을 종료한다.
4. 작업을 완료한 경우 내용 이 파일의 마지막에 `## 에이전트 작업수행내용 : {yyyy-MM-dd HH : MM}` 섹션을 추가하고 작업한 상세 내용을 작성한다.
5. 그밖의 일반적인 작업지침은 [ai_agent_guide.md](/docs/guide/ai_agent_guide.md) 을 확인 후 작업한다.

## 개발자 검토 요청사항
- 지금까지는 maskun.quietchatter.security.adaptor.AnonymousToGuestPromotionFilter 를 통해서 비로그인 사용자를 자동으로 게스트로 로그인을 하고 있다. 
- 이제는 네이버 로그인이 도입됨에 따라 해당 필터를 제거하여 게스트 사용자를 없애고자 한다.
- 따라서 비로그인 사용자는 스프링 시큐리티 anonymousFilter를 그대로 사용하도록 한다.
- 또한 사용자 분류 Enum 중 GUEST를 삭제할 예정이다
- 코딩 작업을 시작하기 전에 작업 계획을 아래에 작성한다. 이후 개발자 검토가 필요한 내용을 작성한다.

## 에이전트 검토 요청: 작업 계획안

게스트 로그인 기능을 완전히 제거하고 익명 사용자 상태를 유지하기 위한 작업 계획입니다.

### 1. 백엔드 변경 사항 (Server-side)

#### 1.1 필터 및 보안 설정 수정
- **`AnonymousToGuestPromotionFilter.java` 삭제**: 비로그인 사용자를 게스트로 자동 승급시키던 로직을 제거합니다.
- **`SecurityConfig.java` 수정**: 필터 체인에서 `AnonymousToGuestPromotionFilter` 등록 코드를 삭제합니다.

#### 1.2 도메인 및 엔티티 수정
- **`Role.java` 수정**: `GUEST` 열거형 상수를 삭제합니다.
- **`Member.java` 수정**: `newGuest()` 및 `newGuest(String nickname)` 정적 팩토리 메서드를 삭제합니다.
- **`MemberRegistrable.java` & `MemberService.java` 수정**: `createNewGuest()` 메서드를 삭제합니다.
- **`AuthMemberService.java` & `AuthMemberServiceImpl.java` 수정**: `createNewGuest()` 메서드를 삭제합니다.

#### 1.3 익명 사용자 행위 처리 (Talk, Reaction)
- **`Talk.java`**: 익명 사용자가 작성할 경우 `memberId`가 `null`이 될 수 있도록 생성자 및 로직을 점검합니다.
- **`TalkCommandApi.java`**: `@AuthenticationPrincipal AuthMember`가 `null`인 경우(익명)에 대한 처리를 추가합니다. 익명 작성 시 닉네임은 "조용한 독서가" 등의 기본값을 사용하도록 합니다.
- **`ReactionCommandApi.java`**: 익명 사용자의 리액션 허용 여부를 결정해야 합니다. (익명 리액션 허용 시, 브라우저 세션이나 IP 기반의 중복 방지가 없으므로 무제한 리액션이 가능해지는 트레이드오프가 있습니다.)

#### 1.4 데이터베이스 마이그레이션 (Flyway)
- `V5__remove_guest_role.sql` 작성:
    - 기존 `member` 테이블에서 `role = 'GUEST'`인 레코드를 삭제하거나 처리합니다.
    - `talk` 및 `reaction` 테이블에서 삭제된 게스트 멤버의 `member_id` 참조를 정리합니다.

#### 1.5 테스트 코드 수정
- `JwtAuthenticateTest`, `AuthMeApiTest`, `MemberServiceTest` 등 게스트 로그인 로직에 의존하는 테스트 케이스를 익명 사용자 기반으로 수정하거나 삭제합니다.

### 2. 프론트엔드 변경 사항 (Client-side)

- **UI 로직 수정**: `Header.tsx` 등에서 `user.role === 'GUEST'`를 확인하여 로그인 유도나 정보 표시를 하던 로직을 `user.isLoggedIn` 기반으로 변경합니다.
- **타입 정의**: `Role` 타입에서 `GUEST`를 제거합니다.

---

### 개발자 확인 요청 사항

1. **익명 사용자의 리액션/톡 작성 정책**: 게스트 계정이 없어짐에 따라, 비로그인 사용자가 작성한 '톡'이나 '리액션'은 `member_id` 없이 (`null`) 저장되게 됩니다. 이 경우 리액션의 중복 방지(1인 1좋아요)가 불가능해지는데, 이를 그대로 수용할지 아니면 리액션/작성은 로그인을 강제할지 결정이 필요합니다. (요구사항 문서에는 "모든 기능 비로그인 허용"으로 되어 있습니다.)
2. **기존 게스트 데이터 처리**: DB에 남아있는 게스트 멤버 레코드와 그들이 작성한 톡/리액션 데이터를 어떻게 처리할까요? (예: 전부 삭제, 혹은 익명으로 유지)

위 계획에 대해 검토 부탁드립니다.

## 개발자 추가 검토반영요청
- 이제 부터 익명사용자의 톡작성, 리액션등의 POST 작업은 허용되지 않는다. 따라서 스프링 시큐리티 설정에서 해당 접근경로는 권한검사가 필요하다.
- 마이그레이션 스크립트 작성시기존의 role = 'GUEST 인 유저를 정회원으로 승급시킨다. 단 Oauth provider는 NONE 상수를 그대로 사용하도록 변경한다.
- 프론트엔드 작업은 해당 태스크에서 제외하도록한다. 
- 위 사항을 반영하여 수정한 계획을 아래에 작성한다. 

## 에이전트 수정된 작업 계획안 (Backend Only)

개발자님의 피드백을 반영하여 익명 사용자의 쓰기 권한을 제한하고, 기존 게스트를 정회원으로 승급시키는 방향으로 수정된 계획입니다. 프론트엔드 작업은 제외합니다.

### 1. 보안 설정 강화 (Spring Security)
- **`SecurityConfig.java` 수정**:
    - `AnonymousToGuestPromotionFilter` 제거.
    - `authorizeHttpRequests` 설정 변경:
        - `GET` 요청은 기존대로 전면 허용 (`permitAll`).
        - `POST`, `PUT`, `DELETE` 등 상태 변경 요청(`/v1/talks/**`, `/v1/reactions/**` 등)은 인증된 사용자(`authenticated()`)만 가능하도록 제한.
- **`AnonymousToGuestPromotionFilter.java` 삭제**.

### 2. 도메인 모델 및 서비스 정리
- **`Role.java`**: `GUEST` 상수 제거.
- **`Member.java`**: `newGuest()` 관련 메서드 제거 및 `Role.GUEST` 참조 코드 삭제.
- **`MemberRegistrable`, `MemberService`, `AuthMemberService`, `AuthMemberServiceImpl`**: `createNewGuest()` 메서드 및 관련 로직 일체 삭제.

### 3. 데이터베이스 마이그레이션 (Flyway)
- **`V5__promote_guest_to_regular.sql` 작성**:
    - `UPDATE member SET role = 'REGULAR' WHERE role = 'GUEST';`
    - 기존 게스트 사용자를 정회원(`REGULAR`)으로 일괄 승급 처리합니다. (Provider는 `NONE` 유지)

### 4. 테스트 코드 현행화
- **`JwtAuthenticateTest`**: 익명 사용자가 더 이상 게스트로 승급되지 않음을 확인하고, 인증이 필요한 API 호출 시 `401 Unauthorized` 또는 `403 Forbidden`이 발생하는지 검증하도록 수정.
- **`AuthMeApiTest`**: 익명 사용자가 `role: anonymous` 상태로 남는지 확인.
- **기타 테스트**: `Role.GUEST`를 사용하거나 `createNewGuest()`를 호출하는 모든 테스트 코드를 수정 또는 삭제.

## 개발자 요구사항
- 해당 작업을 수행하도록 한다.

## 에이전트 작업수행내용 : 2026-02-17 17:10

### 1. 보안 설정 및 필터 제거
- **`AnonymousToGuestPromotionFilter.java` 삭제**: 비로그인 사용자를 게스트로 자동 승급시키던 로직을 완전히 제거하였습니다.
- **`SecurityConfig.java` 수정**:
    - `AnonymousToGuestPromotionFilter` 등록을 제거하였습니다.
    - `authorizeHttpRequests` 설정을 변경하여 `GET` 요청과 `/v1/auth/login/**` 경로를 제외한 모든 상태 변경 요청(`POST`, `PUT`, `DELETE`)에 대해 인증(`authenticated()`)을 요구하도록 강화하였습니다.

### 2. 도메인 모델 및 서비스 계층 정리
- **`Role.java`**: `GUEST` 상수를 제거하였습니다.
- **`Member.java`**: `newGuest()` 관련 정적 팩토리 메서드들을 삭제하였습니다.
- **서비스 인터페이스 및 구현체 수정**: `MemberRegistrable`, `MemberService`, `AuthMemberService`, `AuthMemberServiceImpl`에서 `createNewGuest()` 메서드 및 관련 로직을 일체 삭제하였습니다.

### 3. 데이터베이스 마이그레이션
- **`V5__promote_guest_to_regular.sql` 생성**: 기존 `member` 테이블에서 `role = 'GUEST'`인 모든 레코드를 `REGULAR`로 승급 처리하는 스크립트를 작성하였습니다. (Oauth provider는 기존 `NONE`을 유지)

### 4. 테스트 코드 현행화 및 검증
- **`JwtAuthenticateTest.java`**: 익명 사용자가 더 이상 게스트로 승급되지 않고 스프링 시큐리티의 기본 `anonymousUser` 상태를 유지함을 확인하는 테스트로 수정하였습니다.
- **`AuthMeApiTest.java`**: 익명 사용자의 정보 조회 시 `role: "anonymous"`가 반환됨을 검증하였습니다.
- **기타 테스트**: `MemberTest`, `MemberServiceTest`, `AuthMemberServiceTest` 등에서 `Role.GUEST` 참조를 제거하고 `REGULAR` 또는 네이버 회원 기반으로 테스트 로직을 업데이트하였습니다.
- **전체 테스트 수행**: `./gradlew test`를 실행하여 모든 백엔드 테스트가 통과함을 확인하였습니다. (프론트엔드 작업은 지침에 따라 제외됨)
